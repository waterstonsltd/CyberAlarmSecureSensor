name: Release
on:
  push:
    branches:
      - main
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: waterstonsltd/cyberalarm-securesensor
jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.flag.outputs.RELEASE }}
    steps:
      - name: Check for release flag
        id: flag
        run: |
          MSG="${{ github.event.head_commit.message }}"
          if [[ "$MSG" == *"[release=True]"* ]]; then
            echo "RELEASE=true" >> $GITHUB_OUTPUT
            echo "Release flag found — proceeding"
          else
            echo "RELEASE=false" >> $GITHUB_OUTPUT
            echo "No release flag — skipping"
          fi

  release:
    needs: check
    if: needs.check.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Calculate next version
        id: version
        run: |
          LATEST=$(git tag --list 'v*.*.*' --sort=-v:refname | head -n 1)
          if [ -z "$LATEST" ]; then
            LATEST="v0.0.0"
          fi
          
          CURRENT="${LATEST#v}"
          MAJOR=$(echo "$CURRENT" | cut -d. -f1)
          MINOR=$(echo "$CURRENT" | cut -d. -f2)
          PATCH=$(echo "$CURRENT" | cut -d. -f3)
          
          NEXT_PATCH=$((PATCH + 1))
          NEXT_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}"
          NEXT_TAG="v${NEXT_VERSION}"
          
          echo "VERSION=${NEXT_VERSION}" >> $GITHUB_OUTPUT
          echo "TAG=${NEXT_TAG}" >> $GITHUB_OUTPUT
          echo "Next release: ${NEXT_TAG}"

      - name: Create and push tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag ${{ steps.version.outputs.TAG }}
          git push origin ${{ steps.version.outputs.TAG }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},value=${{ steps.version.outputs.TAG }}
            type=semver,pattern={{major}}.{{minor}},value=${{ steps.version.outputs.TAG }}
            type=sha
            type=raw,value=latest

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./src
          file: ./src/CyberAlarm.SyslogRelay.ConsoleApp/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            BUILD_NUMBER=${{ steps.version.outputs.VERSION }}
            STATUS_ENDPOINT=https://api-ci-cyberalarm.waterstons.win/api/v1/SyslogRelayStatus

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign image with Cosign (keyless)
        run: |
          cosign sign --yes \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}

      - name: Generate SBOM with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}
          format: cyclonedx
          output: sbom.cdx.json

      - name: Attach SBOM to image in registry
        run: |
          cosign attach sbom \
            --sbom sbom.cdx.json \
            --type cyclonedx \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}

      - name: Sign the SBOM attestation
        run: |
          cosign attest --yes \
            --predicate sbom.cdx.json \
            --type cyclonedx \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}

      - name: Prepare release notes
        run: |
          {
            echo "## CyberAlarm SecureSensor ${{ steps.version.outputs.TAG }}"
            echo ""
            if [ -f "RELEASE_NOTES.md" ]; then
              cat RELEASE_NOTES.md
              echo ""
            fi
            echo "### Container Image"
            echo '```bash'
            echo "ghcr.io/waterstonsltd/cyberalarm-securesensor:${{ steps.version.outputs.VERSION }}"
            echo '```'
            echo ""
            echo "**Digest:** \`${{ steps.build.outputs.digest }}\`"
            echo ""
            echo "### Supply Chain Verification"
            echo ""
            echo "This image is signed using [Sigstore Cosign](https://docs.sigstore.dev/) keyless signing and includes a CycloneDX SBOM attestation."
            echo ""
            echo "**Verify image signature:**"
            echo '```bash'
            echo "cosign verify \\"
            echo "  --certificate-oidc-issuer https://token.actions.githubusercontent.com \\"
            echo "  --certificate-identity-regexp github.com/waterstonsltd \\"
            echo "  ghcr.io/waterstonsltd/cyberalarm-securesensor:${{ steps.version.outputs.VERSION }}"
            echo '```'
            echo ""
            echo "**Verify SBOM attestation:**"
            echo '```bash'
            echo "cosign verify-attestation \\"
            echo "  --type cyclonedx \\"
            echo "  --certificate-oidc-issuer https://token.actions.githubusercontent.com \\"
            echo "  --certificate-identity-regexp github.com/waterstonsltd \\"
            echo "  ghcr.io/waterstonsltd/cyberalarm-securesensor:${{ steps.version.outputs.VERSION }}"
            echo '```'
            echo ""
            echo "### Deployment"
            echo ""
            echo "See the [installation guide](https://github.com/waterstonsltd/CyberAlarmSecureSensor#installation) for deployment instructions."
            echo ""
            echo "### Artifacts"
            echo ""
            echo "| Artifact | Format | Description |"
            echo "|----------|--------|-------------|"
            echo "| \`sbom.cdx.json\` | CycloneDX | Software Bill of Materials |"
          } > release_body.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          body_path: release_body.md
          files: sbom.cdx.json